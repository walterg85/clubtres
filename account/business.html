<!-- cropperCSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.9/cropper.min.css" integrity="sha512-w+u2vZqMNUVngx+0GVZYM21Qm093kAexjueWOv9e9nIeYJb1iEfiHC7Y+VvmP/tviQyA5IR32mwN/5hTEJx6Ng==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- cropperJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.9/cropper.min.js" integrity="sha512-9pGiHYK23sqK5Zm0oF45sNBAX/JqbZEP7bSDHyt+nT3GddF+VFIcYNqREt0GDpmFVZI3LZ17Zu9nMMc9iktkCw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<div class="dvContro">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2 pageTitle">Business</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary tmpNewBusiness labelBtnNew">Create new business</button>
            </div>
        </div>
    </div>
    <table class="table" id="businessList">
        <thead class="table-light">
            <th class="colA">#</th>
            <th class="colB">Name</th>
            <th class="colC">Description</th>
            <th class="colD">Address</th>
            <th class="colE">Phone</th>
            <th class="colF">Web page</th>
            <th class="colG"></th>
        </thead>
    </table>
</div>

<figure class="text-center businessAlert d-none my-5">
    <blockquote class="blockquote">
        <p class="blackTitle">Does not manage any business</p>
    </blockquote>
    <figcaption class="blockquote-footer">
        <texto class="blackA">Whenever you want, you can register a new business by</texto> <cite title="clicking here"> <a href="javascript:void(0);" class="tmpNewBusiness"> <texto class="blackB">clicking here</texto> </a> </cite>
    </figcaption>
</figure>
     
<!-- Modal para registrar nuevo Business -->
<div class="modal fade" id="addBusinessModal" tabindex="-1" aria-labelledby="modalTitle2" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle2">Add new business</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="frmBusiness">
                    <input type="hidden" name="idBusiness" id="idBusiness" value="0">
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="inputName" class="form-label labelInputName">Name</label>
                                <input type="text" name="inputName" class="form-control" id="inputName">              
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="inputDescription" class="form-label labelInputDesc">Description</label>
                                <textarea  name="inputDescription" class="form-control" id="inputDescription" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="inputAddress" class="form-label labelInputAddres">Address</label>
                                <textarea  name="inputAddress" class="form-control" id="inputAddress" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="inputNumber" class="form-label labelInputNumber">Phone number</label>
                                <input type="text" name="inputNumber" class="form-control" id="inputNumber">              
                            </div>
                            <div class="mb-3">
                                <label for="inputWeb" class="form-label labelInputWeb">Web page</label>
                                <input type="text" name="inputWeb" class="form-control" id="inputWeb">              
                            </div>
                            <div class="form-check form-switch mb-3 d-none">
                                <input class="form-check-input" type="checkbox" id="chkActive">
                                <label class="form-check-label switch labelCheck" for="chkActive">Active</label>
                            </div> 
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="imageBusiness" class="form-label labelImage">Business image</label>
                                <img class="rounded w-100 d-none img-fluid" id="imgPreview" src="#" alt="Preview" data-btnid="btnDelete" data-foto="1">
                                <input class="form-control form-control-sm" id="imageBusiness" name="imageBusiness" type="file" accept="image/*">
                            </div>
                        </div>                        
                    </div>
                    <button type="button" class="btn btn-primary" id="btnRegisterBusiness">Submit</button>
                    <button type="button" class="btn btn-secondary labelButonC" data-bs-dismiss="modal">Close</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar las imagenes -->
<div class="modal fade" id="modalCrop" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Edit / Crop the photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="img-container mb-3" style="max-height: 500px">
                    <img id="image" src="#">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary labelButonC" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="cropImage">Apply</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var businessPhoto       = null,
        maxCroppedWidth     = 500,
        maxCroppedHeight    = 400,
        dataTableBusiness   = null;

    $(document).ready(function(){
        // Se setea en la variable global, la seccion a la que se esta accediendo para la carga de idioma
        currentSection = "Business";

        // Registrar business
        $("#btnRegisterBusiness").on("click", fnRegisterBusiness);

        // Controlar tipo de objeto que intentan subir
        $('input[type="file"]').on('change', function(){
            let ext = $( this ).val().split('.').pop();

            if ($(this).val() != ""){
                if($.inArray(ext, ["jpg", "jpeg", "png", "bmp", "raw", "tiff"]) != -1){
                    if($(this)[0].files[0].size > 1048576){
                        $( this ).val('');
                        showAlert("error", 'Your selected file is larger than 1MB');
                    }
                }else{
                    $(this).val("");
                    showAlert("error", `${ext} files not allowed, only images`);
                }
            }
        });

        // Image Cropper
        let picture     = null,
            image       = $("#image")[0],
            inputFile   = $("#imageBusiness")[0],
            $modal      = $('#modalCrop'),
            cropper     = null;

        inputFile.addEventListener("change", function(e){
            picture   = $("#imgPreview");
            let files = e.target.files,
                done  = function (url){
                    inputFile.value = "";
                    image.src = url;
                    $modal.modal('show');
                },
                reader,
                file,
                url;

            if (files && files.length > 0){
                file = files[0];

                if (URL){
                    done(URL.createObjectURL(file));
                }
                else if (FileReader){
                    reader = new FileReader();
                    reader.onload = function(e){
                        done(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        $modal.on('shown.bs.modal', function(){
            let URL         = window.URL || window.webkitURL,
                container   = document.querySelector('.img-container'),
                download    = document.getElementById('download');
                actions     = document.getElementById('cropper-buttons'),
                options     = {
                    viewMode: 3,
                    aspectRatio: maxCroppedWidth / maxCroppedHeight,
                    background: false
                };

            cropper = new Cropper(image, options);
        }).on('hidden.bs.modal', function(){
            cropper.destroy();
            cropper = null;
        });

        $("#cropImage").on("click", function(){
            let initialPhotoURL,
                canvas;

            $modal.modal("hide");

            if(cropper){
                canvas = cropper.getCroppedCanvas({
                    width: maxCroppedWidth,
                    height: maxCroppedHeight,
                });

                initialPhotoURL = picture.attr("src");
                picture
                    .attr("src", canvas.toDataURL())
                    .removeClass("d-none");

                canvas.toBlob(function (blob){
                    businessPhoto = blob;
                });
            }
        });

        // resetear el formulario para nuevo comercio
        $(".tmpNewBusiness").on("click", function(){
            $("#inputName").val("");
            $("#inputDescription").val("");
            $("#inputNumber").val("");
            $("#inputAddress").val("");
            $("#inputWeb").val("");
            $("#idBusiness").val(0);
            $("#imgPreview")
                .attr("src", `#`)
                .addClass("d-none");

            businessPhoto = null;

            $(".form-switch").addClass("d-none");
            $("#addBusinessModal").modal("show");
        });

        // Listar comercios
        fnListBusiness();

        // Cambiar idioma de la pagina
        changePageLang();
    });

    function fnRegisterBusiness(){
        let form        = $("#frmBusiness")[0],
            formData    = new FormData(form),
            active      = ($("#chkActive").is(':checked')) ? 1 : 0;

        formData.append('_method', "POST");

        if(businessPhoto)
            formData.append("bannerBusiness", businessPhoto, "businessPhoto.jpg");

        formData.append("chkActive", active);
        $("#btnRegisterBusiness").attr("disabled","disabled");

        $.ajax({
            url: '../core/controllers/business.php',
            data: formData,
            type: 'POST',
            dataType: 'json',
            success: function(response){
                $("#addBusinessModal").modal("hide");
                $("#frmBusiness")[0].reset();
                $("#imgPreview").addClass("d-none");

                fnListBusiness();                
            },
            error: function(jqXHR, textStatus, errorThrown) {
                ajaxResponseError(jqXHR, textStatus);
            },
            complete: function(){
                $("#btnRegisterBusiness").removeAttr("disabled");
            },
            cache: false,
            contentType: false,
            processData: false
        });
    }

    function fnListBusiness(){
        $.ajax({
            url: '../core/controllers/business.php',
            data: { _method: 'GET' },
            type: 'POST',
            dataType: 'json',
            success: function(response){
                let mypaging = false;

                if( (response.data).length == 0 ){
                    $(".businessAlert").removeClass("d-none");
                    $(".dvContro").addClass("d-none");
                }else{
                    $(".businessAlert").addClass("d-none");
                    $(".dvContro").removeClass("d-none");

                    if( (response.data).length > 20 )
                        mypaging = true;
                }

                if (dataTableBusiness != null)
                    dataTableBusiness.destroy();

                dataTableBusiness = $("#businessList").DataTable({
                    data: response.data,
                    columns:
                    [
                        {
                            data: 'id',
                            render: function(data, type, row){
                                return pad(data, 5);
                            }
                        },
                        {
                            data: 'nombre',
                            render: function(data, type, row){
                                return `<a href="../business/index.php?id=${row.id}" target="_blank" class="text-decoration-none text-dark">${data}</a>`;
                            }
                        },
                        {
                            data: 'Descripcion',
                        },
                        {
                            data: 'Direccion',
                        },
                        {
                            data: 'telefono',
                        },
                        {
                            data: 'web',
                        },
                        {
                            data: null,
                            orderable: false,
                            class: "text-center",
                            render: function ( data, type, row )
                            {
                                return `
                                    <a href="javascript:void(0);" class="mr-2 btn btn-outline-secondary btnEditBusiness" title="Edit"><i class="bi bi-pencil"></i></a>
                                    <a href="javascript:void(0);" class="btn btn-outline-danger btnDeleteBusiness" title="Delete"><i class="bi bi-trash"></i></a>
                                `;
                            }
                        }
                    ],
                    "fnDrawCallback":function(oSettings){
                        $(".btnEditBusiness").unbind().click(function(){
                            $("#addBusinessModal").modal("show");

                            let data = getData($(this), dataTableBusiness);

                            $("#inputName").val(data.nombre);
                            $("#inputDescription").val(data.Descripcion);
                            $("#inputNumber").val(data.telefono);
                            $("#inputAddress").val(data.Direccion);
                            $("#inputWeb").val(data.web);
                            $("#idBusiness").val(data.id);

                            $("#imgPreview").addClass("d-none");

                            if(data.image)
                                $("#imgPreview")
                                    .attr("src", `../${data.image}?v=${Math.random()}`)
                                    .removeClass("d-none");

                            businessPhoto = null;
                        });

                        $(".btnDeleteBusiness").unbind().click(function(){
                            let data = getData($(this), dataTableBusiness);
                            (async () => {
                                const tmpResult = await showConfirmation(`Are you sure to eliminate this business? (${data.nombre})`, "this cannot be undone!", "Yes delete");
                                console.log(tmpResult);
                                if(tmpResult.isConfirmed){
                                    $.ajax({
                                        url: '../core/controllers/business.php',
                                        data:{
                                            idBusiness: data.id,
                                            _method: "DELETE"
                                        },
                                        type: 'POST',
                                        success: function(response){
                                            showAlert("success", "Business deleted");
                                            fnListBusiness();
                                        },
                                        error: function(xhr, status) {
                                            console.log(status);
                                        },
                                    });
                                }
                            })()
                        });
                    },
                    searching: false,
                    pageLength: 20,
                    info: false,
                    lengthChange: false,
                    paging: mypaging
                });
            },
            error: function(jqXHR, textStatus, errorThrown) {
                ajaxResponseError(jqXHR, textStatus);
            }
        });
    }

    // Metodo para el cambio de idioma, la variable actualLenguaje, se hereda de la pagina principal index.php
    function changePageLang(){
        $(".pageTitle").html(actualLenguaje[currentSection].pageTitle);
        $(".labelBtnNew").html(actualLenguaje[currentSection].labelBtnNew);
        $(".blackTitle").html(actualLenguaje[currentSection].blackTitle);
        $(".blackA").html(actualLenguaje[currentSection].blackA);
        $(".blackB").html(actualLenguaje[currentSection].blackB);
        $("#modalTitle2").html(actualLenguaje[currentSection].modalTitle2);
        $(".labelInputName").html(actualLenguaje[currentSection].labelInputName);
        $(".labelInputDesc").html(actualLenguaje[currentSection].labelInputDesc);
        $(".labelInputAddres").html(actualLenguaje[currentSection].labelInputAddres);
        $(".labelInputNumber").html(actualLenguaje[currentSection].labelInputNumber);
        $(".labelInputWeb").html(actualLenguaje[currentSection].labelInputWeb);
        $(".labelCheck").html(actualLenguaje[currentSection].labelCheck);
        $(".labelImage").html(actualLenguaje[currentSection].labelImage);
        $("#btnRegisterBusiness").html(actualLenguaje[currentSection].btnRegisterBusiness);
        $(".labelButonC").html(actualLenguaje[currentSection].labelButonC);
        $("#modalLabel").html(actualLenguaje[currentSection].modalLabel);
        $("#cropImage").html(actualLenguaje[currentSection].cropImage);
        $(".colB").html(actualLenguaje[currentSection].labelInputName);
        $(".colC").html(actualLenguaje[currentSection].labelInputDesc);
        $(".colD").html(actualLenguaje[currentSection].labelInputAddres);
        $(".colE").html(actualLenguaje[currentSection].labelInputNumber);
        $(".colF").html(actualLenguaje[currentSection].labelInputWeb);
    }
</script>