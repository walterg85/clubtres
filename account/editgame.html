<!-- datetimepicker -->
<link rel="stylesheet" href="../assets/plugins/datetimepicker/bootstrap-datetimepicker.min.css" />

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="lead">Edit game</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnSavegame">Save</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnCancelreg">Cancel</button>
        </div>
    </div>
</div>

<div class="bd-content ps-lg-4">
    <div class="row">
        <div class="col-4">
            <form class="row g-3">
                <div class="col-12">
                    <div class="mb-3">
                        <label for="inputLeague" class="form-label">* League</label>
                        <select id="inputLeague" name="inputLeague" class="form-select"></select>
                    </div>
                </div>

                <div class="col-6">
                    <div class="mb-3">
                        <label for="inputTeam" class="form-label">* Team 1</label>
                        <select id="inputTeam" name="inputTeam" class="form-select"></select>
                    </div>
                </div>

                <div class="col-6">
                    <div class="mb-3">
                        <label for="inputTeam2" class="form-label">* Team 2</label>
                        <select id="inputTeam2" name="inputTeam2" class="form-select"></select>
                    </div>
                </div>

                <div class="col-12">
                    <div class="mb-3">
                        <label for="inputDate" class="form-label">* Event date</label>
                        <input type="text" class="form-control" id="inputDate" name="inputDate" readonly="readonly">
                    </div>
                </div>         
            </form>
        </div>
        <div class="col-8">
            <label class="form-label">* Indicates the place where the event will take place</label>
            <div id='clubMap' style='width: 100%; height: 50vh;'></div>
        </div>
    </div>
</div>

<!-- Bing Maps -->
<script type='text/javascript' src='https://www.bing.com/api/maps/mapcontrol?key=AiUXV-3R30RqqrIouHt5Px3bZ5d1zd2dujqhVT4Vjj2wpHIZd0YE1YSguYh33-xu&callback=loadMapScenario' async defer></script>

<!-- datetimepicker -->
<script src="../assets/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>

<script type="text/javascript">
    var clubMap = null,
        pushpin = null,
        currentLocation = null,
        currentGame = JSON.parse(localStorage.getItem('currentGame'));

    $(document).ready(function(){
        $("#inputDate").datetimepicker({
            format: "yyyy-mm-dd hh:ii",
            autoclose: true,
            todayBtn: true,
            pickerPosition: "bottom-left",
            startDate:new Date()
        });

        $("#inputDate").val(currentGame.event_date);

        $("#btnCancelreg").on("click", function(){
            $( "#mainContenedor" ).load( `game.html?v=${Math.random()}` );
        });

        $("#inputLeague").change( fnListTeams);

        $("#btnSavegame").on("click", function(){
            if($("#inputLeague").val() == 0){
                alert("You must choose a league for the game");
                return false;
            }

            if($("#inputTeam").val() == 0 || $("#inputTeam2").val() == 0){
                alert("You must choose both teams for the game");
                return false;
            }

            if($("#inputTeam").val() == $("#inputTeam2").val()){
                alert("You can't choose the same team for the game");
                return false;
            }

            if($("#inputDate").val() == ""){
                alert("You must choose a date for the event");
                return false;
            }

            if(!currentLocation){
                alert("You must indicate on the map the place of the event");
                return false;
            }

            let objData = {
                "_method": "updateEvent",
                "eventId": currentGame.id,
                "leagueId": $("#inputLeague").val(),
                "team1": $("#inputTeam").val(),
                "team2": $("#inputTeam2").val(),
                "date": $("#inputDate").val(),
                "location": JSON.stringify(currentLocation)
            };

            if (confirm(`Do you want to update this event?`)){
                $.post("../core/controllers/league.php", objData, function(result) {
                    alert(result.message)

                    if(result.codeResponse == 200)
                        $( "#mainContenedor" ).load( `game.html?v=${Math.random()}` );
                }).fail( function(jqXHR, textStatus, errorThrown){
                    ajaxResponseError(jqXHR, textStatus);
                });
            }
        });

        fnListLeague();
    });

    function loadMapScenario() {
        let navigationBarMode = Microsoft.Maps.NavigationBarMode;

        clubMap = new Microsoft.Maps.Map(document.getElementById('clubMap'), {
            navigationBarMode: navigationBarMode.square,
            supportedMapTypes: [Microsoft.Maps.MapTypeId.road, Microsoft.Maps.MapTypeId.aerial]
        });

        Microsoft.Maps.Events.addHandler(clubMap, 'click',getLatlng );

        let jsLoc = JSON.parse(currentGame.locations),
            location = new Microsoft.Maps.Location(jsLoc.latitude, jsLoc.longitude);

        currentLocation = {latitude: jsLoc.latitude, longitude: jsLoc.longitude};

        pushpin = new Microsoft.Maps.Pushpin(location, {'draggable': false});
        clubMap.entities.push(pushpin);
    }

    function getLatlng(e) {
        if (e.targetType == "map") {
            if(pushpin)
                clubMap.entities.remove(pushpin);

            let point = new Microsoft.Maps.Point(e.getX(), e.getY()),
                locTemp = e.target.tryPixelToLocation(point),
                location = new Microsoft.Maps.Location(locTemp.latitude, locTemp.longitude);

            currentLocation = {latitude: locTemp.latitude, longitude: locTemp.longitude};
            pushpin = new Microsoft.Maps.Pushpin(location, {'draggable': false});

            clubMap.entities.push(pushpin);
        }
    }

    function fnListLeague(){
        $.ajax({
            url: '../core/controllers/league.php',
            data: { _method: 'GET' },
            type: 'POST',
            dataType: 'json',
            success: function(response){
                let options = '<option value="0">Choose an option</option>';
                $.each(response.data, function( index, item){
                    if(item.type == 1)
                        options += `<option value="${item.id}">${item.name}</option>`;
                });

                $("#inputLeague").html("");
                $(options).appendTo("#inputLeague");

                $("#inputLeague").val(currentGame.league_id);
                fnListTeams();
            },
            error: function(jqXHR, textStatus, errorThrown) {
                ajaxResponseError(jqXHR, textStatus);
            }
        });
    }

    function fnListTeams(){
        let objData = {
                "_method": "getChilds",
                "leagueId": $("#inputLeague").val()
            };

        $.post("../core/controllers/league.php", objData, function(result) {
            let options = '<option value="0">Choose an option</option>';
            $.each(result.data, function( index, item){
                if(item.status == 1)
                    options += `<option value="${item.id}">${item.name}</option>`;
            });

            $("#inputTeam").html("");
            $("#inputTeam2").html("");

            $(options).appendTo("#inputTeam");
            $(options).appendTo("#inputTeam2");

            $("#inputTeam").val(currentGame.teama_id);
            $("#inputTeam2").val(currentGame.teamb_id);
        }).fail( function(jqXHR, textStatus, errorThrown){
            ajaxResponseError(jqXHR, textStatus);
        });
    }
</script>